---
layout:     post
title:      "微服务组件-Nacos注册中心实战"
subtitle:   " \"微服务组件-Nacos注册中心实战\""
date:       2021-12-15 14:06:00 +0800
author:     "snowball"
header-img: "img/post-bg-unix-linux.jpg"
tags:
    - Spring Cloud
    - Nacos
    - 微服务注册中心
    - 微服务组件
typora-root-url: ..
---

<!--  “微服务组件-Nacos注册中心实战. ” -->

### 主要内容

#### 1.微服务架构及技术栈介绍

web应用架构：单体架构、微服务架构（分布式架构解决方案，可去中心化）

SOA架构：集中化

Service Mesh: 去中心化

##### 1.1 单体架构

单体架构：一个归档包（例如war格式）包含了应用所有功能的应用程序，我们通常称之为单体应用。架构单体应用的方法论，我们称之为单体应用架构。（一个war/jar包打天下），应用场景常在大多数中小型项目使用。

单体架构示意图:

![单体架构](/img/in-post/post-nacos-use/单体架构.png)

**优点:**

1. 架构简单明了，没有”花里胡哨“的问题需要解决。
2. **开发，测试，部署简单**（尤其是运维人员 睡着都会笑醒）

**缺点:**

1. 随着业务扩展，**代码越来越复杂**，代码质量参差不齐(开发人员的水平不一),会让你每次提交代码 ，修改每一个小bug都是心惊胆战的。
2. 代码量大了，**部署慢**(由于单体架构，功能复杂) ，能想像下一个来自200W+代码部署的速度(15分钟)
3. **扩展成本高**，根据单体架构图 假设用户模块是一个CPU密集型的模块(涉及到大量的运算)，那么我们需要替换更加牛逼的CPU，而我们的订单模块是一个IO密集模块（涉及大量的读写磁盘）,那我们需要替换更加牛逼的内存以及高效的磁盘。但是我们的单体架构上 无法针对单个功能模块进行扩展，那么就需要替换更牛逼的CPU，更牛逼的内存，更牛逼的磁盘，价格蹭蹭的往上涨。
4. 阻碍了新技术的发展；比如web架构模块 从struts2迁移到springboot，那么就会成为灾难性

如上所述，优点和缺点同样明显，适合中小型项目或团队，也是web应用早年的主要架构。



##### 1.2 微服务以及微服务架构

**定义：**

英文:https://martinfowler.com/articles/microservices.html

中文:http://blog.cuicc.com/blog/2015/07/22/microservices

微服务核心就是把传统的单机应用，根据业务将单机应用拆分为一个一个的服务，彻底的解耦，每一个服务都是提供特定的功能，一个服务只做一件事，类似进程，每个服务都能够单独部署，甚至可以拥有自己的数据库。这样的一个一个的小服务就是微服务。

1. 比如传统的单机电商应用,有 订单/支付/库存/物流/积分等模块(理解为service)
2. 我们根据 业务模型来拆分,可以拆分为 订单服务，支付服务，库存服务，物流服务，积分服务
3. 若不拆分的时候，我的非核心业务积分模块 出现了重大bug 导致系统内存溢出，导致整个服务宕机,若拆分之后，只是说我的积分微服务不可用，我的整个系统核心功能还是能使用



**特点：**

1）独立部署，灵活扩展

2）资源的有效隔离

3）团队组织架构的调整



**优点:**

1. 每个服务足够小，足够内聚，代码更加容易理解，专注一个业务功能点(对比传统应用，可能改几行代码 需要了解整个系统)
2. 开发简单，一个服务只干一个事情。（加入你做支付服务，你只要了解支付相关代码就可以了）
3. 微服务能够被2-5个人的小团队开发，**提高效率**
4. 按需伸缩，**服务松耦合**，每个服务都能够开发部署
5. 前后端分离, 作为java开发人员，我们只要关系后端接口的安全性以及性能，不要去关注页面的人机交互(H5工程师)根据前后端接口协议，根据入参，返回json的回参。
6. 一个服务可用拥有自己的数据库，也可以多个服务连接同一个数据库。



**缺点:**

1. 增加了运维人员的工作量，以前只要部署一个war包，现在可能需要部署成百上千个war包(k8s+docker+jenkins)
2. 服务之间相互调用，增加通信成本
3. 数据一致性问题(分布式事务问题)
4. 性能监控等,问题定位..........................



**微服务的适用场景**

合适

- 大型复杂的项目............(来自单体架构200W行代码的恐惧)
- 快速迭代的项目............(来自一天一版的恐惧)
- 并发高的项目................(考虑弹性伸缩扩容的恐惧)

不合适

- 业务稳定，就是修修bug ，改改数据
- 迭代周期长 发版频率 一二个月一次



##### 1.3 Spring Cloud 微服务技术栈

**介绍：**

spring、spring boot、spring cloud区别：

Spring：基于Bean的管理，对象管理、AOP等功能框架，例如Mybatis的SqlSessionFactory，xml，@Bean

Spring Boot：基于Application，拥有自动配置能力，快速开发框架

Spring Cloud：基于Service，集成了微服务架构共性功能



**Spring Cloud**是分布式微服务架构的一站式解决方案，是多种微服务架构落地技术的集合体，俗称微服务全家桶。
Spring Cloud为开发人员提供了快速构建分布式系统中的一些常见模式的工具(例如配置管理、服务发现、断路器、智能路由、微代理、控制总线、一次性令牌、全局锁、领导选举、分布式会话、集群状态)。

官网： https://spring.io/projects/spring-cloud
中文文档： https://www.springcloud.cc/
Spring Cloud中国社区：http://springcloud.cn/



微服务之间调用存在什么问题，需要用到什么技术？

- RPC调用：feign、dubbo
- 服务注册与发现：eureka、nacos
- 配置统一管理：zookeeper、nacos、redis
- 服务链路的排查，微服务的监控：skywalking、zipkin+sleuth



这些问题在微服务框架中是常见的问题，在框架中需要解决这些问题和解决。而不同的问题在不同公司有不同的解决方案，就对应了不同的微服务中间件，在微服务中有Netflix，Alibaba(开源)，Huawei(闭源)等公司的全家桶中间件实现方案，下面主要讲述spring cloud alibaba的微服务技术栈。



**spring cloud alibaba的使用手册图**:https://www.processon.com/view/link/60519545f346fb348a97c9d5

![spring_cloud_alibaba](/img/in-post/post-nacos-use/spring_cloud_alibaba.png)



**Spring Cloud Netflix**:

- Eureka，服务注册和发现，它提供了一个服务注册中心、服务发现的客户端，还有一个方便的查看所有注册的服务的界面。 所有的服务使用Eureka的服务发现客户端来将自己注册到Eureka的服务器上。
- Zuul，网关，所有的客户端请求通过这个网关访问后台的服务。他可以使用一定的路由配置来判断某一个URL由哪个服务来处理。并从Eureka获取注册的服务来转发请求。
- Ribbon，即负载均衡，Zuul网关将一个请求发送给某一个服务的应用的时候，如果一个服务启动了多个实例，就会通过Ribbon来通过一定的负载均衡策略来发送给某一个服务实例。
- Feign，服务客户端，服务之间如果需要相互访问，可以使用RestTemplate，也可以使用Feign客户端访问。它默认会使用Ribbon来实现负载均衡。
- Hystrix，监控和断路器。我们只需要在服务接口上添加Hystrix标签，就可以实现对这个接口的监控和断路器功能。
- Hystrix Dashboard，监控面板，他提供了一个界面，可以监控各个服务上的服务调用所消耗的时间等。
- Turbine，监控聚合，使用Hystrix监控，我们需要打开每一个服务实例的监控信息来查看。而Turbine可以帮助我们把所有的服务实例的监控信息聚合到一个地方统一查看。这样就不需要挨个打开一个个的页面一个个查看。

![spring_cloud_netflix_1](/img/in-post/post-nacos-use/spring_cloud_netflix_1.png)

![spring_cloud_netflix_2](/img/in-post/post-nacos-use/spring_cloud_netflix_2.png)

**Spring Cloud Alibaba技术栈:**

同 Spring Cloud 一样，Spring Cloud Alibaba 也是一套微服务解决方案，包含开发分布式应用微服务的必需组件，方便开发者通过Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。

依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里微服务解决方案，通过阿里中间件来迅速搭建分布式应用系统。

作为 Spring Cloud 体系下的新实现，Spring Cloud Alibaba 跟官方的组件或其它的第三方实现如 Netflix, Consul，Zookeeper 等对比，具备了更多的功能:

![spring_cloud_alibaba_compare](/img/in-post/post-nacos-use/spring_cloud_alibaba_compare.png)



**阿里开源组件:**

Nacos：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。

Sentinel：把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。

RocketMQ：开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布与订阅服务。

Dubbo：在国内应用非常广泛的一款高性能 Java RPC 框架。

Seata：阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案。

Arthas：开源的Java动态追踪工具，基于字节码增强技术，功能非常强大。

阿里商业化组件作为一家商业公司，阿里巴巴推出 Spring Cloud Alibaba，很大程度上市希望通过抢占开发者生态，来帮助推广自家的云产品。

Alibaba Cloud ACM：一款在分布式架构环境中对应用配置进行集中管理和推送的应用配置中心产品。

Alibaba Cloud OSS：阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的云存储服务

Alibaba Cloud SchedulerX：阿里中间件团队开发的一款分布式任务调度产品，提供秒级、精准的定时（基于Cron 表达式）任务调度服务。

![alibaba微服务架构图](/img/in-post/post-nacos-use/alibaba微服务架构图.png)

**Spring Cloud Alibaba版本选择与组件关系**

[链接地址](https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E)

![spring_cloud_alibaba_version](/img/in-post/post-nacos-use/spring_cloud_alibaba_version.png)

文章中项目使用的版本选择： Spring Cloud Alibaba 2.2.5.RELEASE，Spring Cloud Hoxton.SR8

pom.xml代码

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.funny</groupId>
    <artifactId>spring-cloud-alibaba-notice</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <java.version>1.8</java.version>
        <spring.cloud.version>Hoxton.SR8</spring.cloud.version>
        <spring.cloud.alibaba.version>2.2.5.RELEASE</spring.cloud.alibaba.version>
    </properties>

    <modules>
        <module>order-service</module>
        <module>user-service</module>
    </modules>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring.cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>${spring.cloud.alibaba.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

</project>
```

案例项目工程地址：https://gitee.com/snowball2dev/spring-cloud-alibaba-notice

#### 2.微服务架构注册中心的作用和设计思路

##### 2.1 注册中心演变及其设计思想

在讲述服务注册中心中间件开源方案之前，先思考以下问题：假设没有Spring Cloud技术栈，怎样完成微服务之间的调用？（提倡带着问题去学习和思考开源中间件，这样更容易让你快速掌握其核心）

平时常用的使用方式，就是RestTemplate不同web应用间的调用：

```
//RestTemplate调用
String url = "http://localhost:8080/order/findOrderByUserId/" + userId;
Resp result = restTemplate.getForObject(url, Resp.class);
```

上述方式就可以实现不同web服务的调用，但是也存在以下问题：

- 另外的服务端口地址硬编码，扩展性差，没有客户端负载均衡
- 无法水平扩容，客户端无法感知服务提供端是否可用
- 等等

这些问题都可以通过服务注册中心来解决，请看下面注册中心的逐步实现思路图：

思路版本1：

![注册中心实现思路1](/img/in-post/post-nacos-use/注册中心实现思路1.png)

思路版本2：

![注册中心实现思路2](/img/in-post/post-nacos-use/注册中心实现思路2.png)

最终思路版本3：

![注册中心实现思路3](/img/in-post/post-nacos-use/注册中心实现思路3.png)

心跳机制：服务续约，客户端向服务端定时发送心跳，服务端接收到心跳后修改服务的续约时间

服务剔除或者降级可以利用服务的最后续约时间进行判断处理。

##### 2.2 Nacos服务注册中心

官方文档： https://nacos.io/zh-cn/docs/what-is-nacos.html

Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。

Nacos 的关键特性包括:

- 服务发现和服务健康监测
- 动态配置服务
- 动态 DNS 服务
- 服务及其元数据管理



#### 3.Nacos注册中心架构剖析

##### 3.1 Nacos架构

![Nacos架构图1](/img/in-post/post-nacos-use/Nacos架构图1.png)

NamingService: 命名服务，注册中心核心接口（）

ConfigService：配置服务，配置中心核心接口 （）

OpenAPI文档：https://nacos.io/zh-cn/docs/open-api.html

nacos版本： v1.4.1



##### 3.2 Nacos Server部署

分为单机模式或集群模式，参考官网或者百度资料，本地开发使用单机模式启动



##### 3.3 核心功能

![Nacos架构图2](/img/in-post/post-nacos-use/Nacos架构图2.png)

**服务注册**：Nacos Client会通过发送REST请求的方式向Nacos Server注册自己的服务，提供自身的元数据，比如ip地址、端口等信息。Nacos Server接收到注册请求后，就会把这些元数据信息存储在一个双层的内存Map中。

**服务心跳**：在服务注册后，Nacos Client会维护一个定时心跳来持续通知Nacos Server，说明服务一直处于可用状态，防止被剔除。默认5s发送一次心跳。

**服务同步**：Nacos Server集群之间会互相同步服务实例，用来保证服务信息的一致性。（Raft协议）

**服务发现**：服务消费者（Nacos Client）在调用服务提供者的服务时，会发送一个REST请求给Nacos Server，获取上面注册的服务清单，并且缓存在Nacos Client本地，同时会在Nacos Client本地开启一个定时任务定时拉取服务端最新的注册表信息更新到本地缓存。

**服务健康检查**：Nacos Server会开启一个定时任务用来检查注册服务实例的健康情况，对于超过15s没有收到客户端心跳的实例会将它的healthy属性置为false(客户端服务发现时不会发现)，如果某个实例超过30秒没有收到心跳，直接剔除该实例(被剔除的实例如果恢复发送心跳则会重新注册)



##### 3.4 服务注册表结构

![Nacos服务注册表结构](/img/in-post/post-nacos-use/Nacos服务注册表结构.png)

服务注册实例临时节点存储在内存，持久化节点存储在data/naming/namespace的id

nacos服务实例列表拉取一次性返回临时和持久实例

服务配置存储在derby，mysql中

具体细节可以查看nacos-server工程源码，源码下载地址： https://github.com/alibaba/nacos/



##### 3.5 服务领域模型

![Nacos服务领域模型](/img/in-post/post-nacos-use/Nacos服务领域模型.png)

##### 3.6 服务实例数据

```
http://localhost:8848/nacos/v1/ns/instance/list?serviceName=user-service

{
"hosts": [
      {
        "ip": "192.168.0.173",
        "port": 8081,
        "valid": true,
        "healthy": true,
        "marked": false,
        "instanceId": "192.168.0.173#8081#DEFAULT#DEFAULT_GROUP@@user-service",
        "metadata": {
        	"preserved.register.source": "SPRING_CLOUD"
        },
        "enabled": true,
        "weight": 1,
        "clusterName": "DEFAULT",
        "serviceName": "user-service",
        "ephemeral": true
       }
    ],
    "dom": "user-service",
    "name": "DEFAULT_GROUP@@user-service",
    "cacheMillis": 3000,
    "lastRefTime": 1639473956295,
    "checksum": "890112f09b172afa468f32d37e6fe828",
    "useSpecifiedURL": false,
    "clusters": "",
    "env": "",
    "metadata": {}
}
```



#### 4.Spring Cloud Alibaba Nacos使用详解

案例项目工程地址：https://gitee.com/snowball2dev/spring-cloud-alibaba-notice

1.创建项目，引入依赖，父pom.xml文件见工程，以下是服务注册中心模块依赖

```
 <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
 </dependency>
```

2.配置Nacos：https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery

3.服务restTemplate调用：

```
//restTemplate扩展点 ClientHttpRequestInterceptor
//ribbon LoadBalancerInterceptor
//order-service => localhost:8080
String url = "http://order-service/order/findOrderByUserId/" + userId;
Resp result = restTemplate.getForObject(url, Resp.class);
```

```
@Bean
@LoadBalanced
public RestTemplate restTemplate(){
        RestTemplate restTemplate = new RestTemplate();
//        restTemplate.setInterceptors(Collections.singletonList(new //LoadBalancerInterceptor(loadBalancerClient)));
        return restTemplate;
}
```

4.启动应用，Nacos管理页面查看服务启动情况，http://localhost:8848/nacos

5.访问接口，观察结果，http://localhost:8081/user/findOrderByUserId/test



#### 5.Nacos Server高可用集群部署

官网文档：https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html

这里的具体步骤文档可以百度，或者找笔者获取



#### 6.Nacos内核NamingService详解

nacos-server工程源码，源码下载地址： https://github.com/alibaba/nacos/

NamingService: 命名服务，注册中心核心接口，包含注册，取消注册，移除，获取实例列表等功能

com.alibaba.nacos.api.naming.NamingService 

服务注册过程:

```
//nacos-client
NamingService#registerInstance(String serviceName, String ip, int port)
->NacosNamingService#registerInstance(String serviceName, String groupName, Instance instance)
->...
//发起http请求服务端的注册实例api,/nacos/v1/ns/instance
->NamingProxy#reqApi()
```

```
//nacos-server
InstanceController#register
->com.alibaba.nacos.naming.core.ServiceManager#registerInstance
```

源码细节后续文章会详细分析，这里只是初略看一下



#### 7.Nacos服务实例注册表结构详解

nacos-server工程：

内存注册表结构：

```
com.alibaba.nacos.naming.core.ServiceManager
Map<String, Map<String, Service>> serviceMap; //服务集合
Map(namespace, Map(group::serviceName, Service))
第一层key，namespace，隔离作用，用于环境隔离，prod/test/dev
第二层key，group:serviceName,隔离作用,group，所有服务用同一个group，通用用于配置中心

com.alibaba.nacos.naming.core.Service
Map<String, Cluster> clusterMap; //服务下的集群集合，集群的实例互通

com.alibaba.nacos.naming.core.Cluster
//集群下的持久实例
Set<Instance> persistentInstances;
//集群下的临时实例，值的key配置，spring.cloud.nacos.discovery.ephemeral
Set<Instance> ephemeralInstances;
```

![Nacos服务注册表结构](/img/in-post/post-nacos-use/Nacos服务注册表结构.png)



#### 8.Nacos是如何整合到SpringCloudAlibaba中的

```
Nacos---->整合
	Spring Cloud Alibaba Nacos-->遵循Spring Cloud规范
		Spring Cloud-->依赖
			Spring Boot-->封装
				Spring
```

```
AbstractApplicationContext#finishRefresh
----->发布完成刷新事件，自动服务注册抽象类监听了WebServerInitializedEvent
AbstractAutoServiceRegistration implements ApplicationListener#onApplicationEvent
----->开始注册
AbstractAutoServiceRegistration#start
----->调用ServiceRegistry对象register方法，是服务注册规范接口的实现类
ServiceRegistry.register()
---->Spring Cloud Alibaba Nacos服务自动注册
com.alibaba.cloud.nacos.registry.NacosServiceRegistry#register
---->Nacos服务注册接口
com.alibaba.nacos.client.naming.NacosNamingService#registerInstance()
```

NacosServiceRegistry.register打断点，具体详细调用栈如下：

![Nacos服务注册调用栈](/img/in-post/post-nacos-use/Nacos服务注册调用栈.png)



以上就是Nacos整合到Spring Cloud Alibaba Nacos的大致扩展点和回调过程了。
