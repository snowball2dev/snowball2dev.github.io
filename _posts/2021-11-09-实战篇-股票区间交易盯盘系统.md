---
layout:     post
title:      "实战篇-股票区间交易盯盘系统"
subtitle:   " \"股票区间交易盯盘系统\""
date:       2021-11-09 11:26:00 +0800
author:     "snowball"
header-img: "img/home-bg-o.jpg"
tags:
    - SpringBoot
    - 股票
    - 项目实战
    - 技术
typora-root-url: ..
---

<!--  “股票区间交易盯盘系统. ” -->

### 实战篇-股票区间交易盯盘系统

#### 简介

大家好，今天给大家分享的内容是股票交易相关功能开发，如果读者对股票或金融衍生物交易不太了解，又比较感兴趣的话可自行查询相关资料。

接下来笔者会给大家介绍股票交易中的常见几种交易策略实现思路和源码编写过程，如果大家听说过量化交易这个词语的话，对其中的交易策略或许了解过，大概意思就是**在股票、加密货币或者金融衍生物在价格的波动过程中根据其交易策略进行不断的买入和卖出，不断的套利，降低持仓陈本，来达到收益最大化**。

常见的交易策略有很多种，例如趋势型，网格型，剥头皮，概率法则，高频交易等，今天主要给大家介绍2种低频的交易策略，高抛低吸网格交易策略、日内做T策略。其他的交易策略较复杂，读者可自行百度了解，笔者这里推荐一个量化交易网站，仅供参考。[米筐量化](https://www.ricequant.com/doc/quant/)

[线上体验地址](http://139.9.191.103:8068/)

#### 需求分析&实现思路

每个交易日的股票都会上涨或者下跌，在这个过程中笔者们偶尔会想针对部分股票进行股价的涨跌幅进行监控，或者自动进行交易，在这个需求前提下，现有券商、股票分析软件都会带有机器人自动交易策略功能，大部分都需要收费或者部分策略不能满足自己的需求，笔者这边提供2种实现思路：

1、借助现有量化平台编写策略和回测分析，然后在券商软件层面进行策略执行

2、自己编写功能代码来监控估价，对股价波动进行特殊处理满足特殊需求。

第一种实现成本较低，但功能受限于平台；第二种实现成本毋庸置疑相对较高，逻辑可以自己控制

#### 借助现有量化平台编写策略和回测分析

这里利用米筐量化实现和分析自己的交易策略，需要先注册个账号，然后进入到平台-笔者的策略中进行策略编写，平台的功能使用可以参考平台文档

笔者这里贴出笔者自己写的2种策略代码，这个平台只支持使用Python脚本编写

##### 价差交易策略

平台截图：

![价差交易策略代码](/img/in-post/post-stock-trade/价差交易策略代码.png)

部分代码如下，详细代码可以自己手撸实现，也可以联系小编获取：

```
# 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新
def handle_bar(context, bar_dict):
	...
    if newPrice >= context.nextSellPrice:
        logger.info("执行高抛交易,对应价格:{}".format(newPrice))
        amount = context.portfolio.positions[context.s1].quantity
        if amount >= context.tradeNumber:
            logger.info("执行高抛交易,对应数量:{}".format(context.tradeNumber))
            order_shares(context.s1, -context.tradeNumber)
            plot("S", newPrice)
        elif amount >= 100:
            logger.info("执行高抛交易,对应数量:{}".format(amount))
            order_shares(context.s1, -amount)
            plot("S", newPrice) 
        
        calc_next_trade_price(context,newPrice)
        obj = {
            "nextSellPrice":context.nextSellPrice,
            "nextBuyPrice":context.nextBuyPrice,
            "curTradePrice":context.curTradePrice
        }
        context.buyTradeList.append(obj)

    if newPrice <= context.nextBuyPrice:
        logger.info("执行低吸交易,对应价格:{}".format(newPrice))
        amount = int(context.portfolio.cash / newPrice / 100.0)  * 100
        if amount >= context.tradeNumber:
            logger.info("执行低吸交易,对应数量:{}".format(context.tradeNumber))
            order_shares(context.s1, context.tradeNumber)
            plot("B", newPrice)

        calc_next_trade_price(context,newPrice)
       
        obj = {
            "nextSellPrice":context.nextSellPrice,
            "nextBuyPrice":context.nextBuyPrice,
            "curTradePrice":context.curTradePrice
        }
        context.sellTradeList.append(obj)    
```

选择回测时间段，点击右侧平台右侧按钮运行回测，结果页面如下

![价差交易策略运行结果](/img/in-post/post-stock-trade/价差交易策略运行结果.png)

从结果中可以看到，对招商银行[600036]这只股票进行价差网格交易，其参数设置在上涨8%的时候卖出，下跌8%的时候买入，最大连续下跌买入次数为3次

回测收益：13.628%

回测年化收益：17.096%

比基准年化收益-6%高出非常之大，这是在股价波动的过程中可以进行执行该策略来不断的降低持仓成本。从交易详情面板来看，这个策略可以通过参数调节交易频率，在上涨下跌比率较大的情况下，其交易次数是能控制的相对较少，结果图如下：

![价差交易交易详情](/img/in-post/post-stock-trade/价差交易交易详情.png)

##### 日内做T策略

同样的，只贴部分代码

```
# 你选择的证券的数据更新将会触发此段逻辑，例如日或分钟历史数据切片或者是实时数据切片更新
def handle_bar(context, bar_dict):
	...
    newPrice = bar_dict[context.s1].last
    if newPrice >= context.nextSellPrice:
        context.lastTradeType = 1
        logger.info("执行高抛交易,对应价格:{}".format(newPrice))
        amount = context.portfolio.positions[context.s1].quantity
        #if amount - context.tradeNumber >= context.lockStockNumber:
        if amount - context.tradeNumber >= 0:
            logger.info("执行高抛交易,对应数量:{}".format(context.tradeNumber))
            order_shares(context.s1, -context.tradeNumber)
            plot("S", newPrice)
        else:
            logger.info("股票数量不足，无法执行高抛交易,对应数量:{}".format(amount))
            return    
        
        calc_next_trade_price(context,newPrice)

        obj = {
            "nextSellPrice":context.nextSellPrice,
            "nextBuyPrice":context.nextBuyPrice,
            "curTradePrice":context.curTradePrice
        }
        context.buyTradeList.append(obj)

    if newPrice <= context.nextBuyPrice:
        context.lastTradeType = 0
        logger.info("执行低吸交易,对应价格:{}".format(newPrice))
        amount = int(context.portfolio.cash / newPrice / 100.0)  * 100
        if amount >= context.tradeNumber:
            logger.info("执行低吸交易,对应数量:{}".format(context.tradeNumber))
            order_shares(context.s1, context.tradeNumber)
            plot("B", newPrice)
        else:
            logger.info("现金不足，无法执行低吸交易,对应数量:{}".format(amount))
            return    

        calc_next_trade_price(context,newPrice)
       
        obj = {
            "nextSellPrice":context.nextSellPrice,
            "nextBuyPrice":context.nextBuyPrice,
            "curTradePrice":context.curTradePrice
        }
        context.sellTradeList.append(obj) 
```

总体来说，代码逻辑还是比较简单，就是对价格的涨跌进行处理，其参数设置在日内上涨2%的时候卖出，下跌2%的时候买入，初始买入资金比例7成，锁定最低仓位5成。然后运行回测，其结果如下

![日内做T交易策略结果](/img/in-post/post-stock-trade/日内做T交易策略结果.png)

回测收益：5.501%

回测年化收益：6.839%

基准收益：19.26%

可以看到日内做T这种高频交易，在长期来看收益可能并不高，适合在短期价格内运行。



小的总结，这个量化平台在笔者的熟悉情况下，它可以很方便的回测你的交易策略，但是在股价盯盘上，或者自定义逻辑上支持的不是很完善，很多功能也是需要收费才能使用，下面笔者简单介绍下手撸个股票区间交易盯盘系统的实现过程。

#### 区间交易盯盘系统

##### 实现思路

![实现流程图](/img/in-post/post-stock-trade/实现流程图.png)

大致分为以下四大功能模块，分别为

股票池：

需要获取数据的股票列表



股票实时数据收集服务：

针对不同数据源配置拉取对应的股票实时数据，并提供重试机制



股票组合、交易策略配置、交易策略运行：

具体可以参考接口文档，代码实现



通知服务：

通知支持邮件通知，企业微信聊天机器人通知。（在application.yml配置）



##### 代码实现

工程采用单机应用架构，使用框架为SpringBoot + Spring Data Jpa + Redis等常规开发框架。数据库采用mysql，结构和文件见源码工程data目录

源码地址：https://gitee.com/snowball2dev/stock-trade-strategy

maven工程结构

```
stock-back-test	
策略回测模块，暂未实现

stock-base
基础模块，主要是通用工具类

stock-data
股票数据模块，功能包含股票池、股票数据源实时采集、数据更新、事件通知等

stock-platform
股票后台平台启动模块，包含工程配置

stock-trade
股票交易策略模块，功能有股票组合管理、网格交易策略参数配置、T0交易参数配置、2种交易策略的实现和执行等

stock-user
用户模块，包含用户基础功能
```

##### 接口文档

![盯盘系统所有接口](/img/in-post/post-stock-trade/盯盘系统所有接口.png)

这里贴一个接口，其他接口见接口文档地址描述

```
网格交易-创建/更新计划
/stock/tradePlan/grid/save
```

![创建价差策略接口](/img/in-post/post-stock-trade/创建价差策略接口.png)

##### 部署工程

1.根据data目录下的stock_sql.sql创建数据库相关表

2.修改工程yml配置文件，配置自己的邮箱通知地址、企业微信聊天机器人地址

3.maven工程对stock-platform模块进行package打包，将输出的jar包上传到服务器，运行jar

##### 运行效果

表结构

![表结构](/img/in-post/post-stock-trade/表结构.png)

Idea本地运行日志

![Idea启动截图](/img/in-post/post-stock-trade/Idea启动截图.png)

服务端运行目录

![服务器运行目录](/img/in-post/post-stock-trade/服务器运行目录.png)

服务端运行日志

![运行日志2](/img/in-post/post-stock-trade/运行日志2.png)

##### 小结

以上就是手写的区间交易盯盘系统相关功能描述和结果展示，包含用户模块、股票模拟组合模块、套利策略模块、股票通用模块等，工程后端服务在服务器单机部署，在A股股票实践验证几个月，代码暂无发现bug，部分结果通知截图暂未提供，读者可以自行下载代码使用Idea运行工程实践，有什么问题和想法随时可以留言或者联系小编。

#### 总结

以上就是笔者根据个人炒股经验和量化交易知识，独立在业余时间花了1个月左右零碎时间开发的股票区间交易的盯盘后台系统，实现了高抛低吸网格交易策略、日内做T策略两种策略的线上运行，以及触发交易的通知机制功能。虽然功能完善性可能不是很够，但基本可以满足这两种策略的套利功能。对股票自动交易策略有兴趣、实战项目想了解的读者可以下载源代码阅读，也欢迎读者留言分享自己的看法。

#### 